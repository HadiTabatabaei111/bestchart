<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸš¨ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙÛŒÙˆÚ†Ø±Ø² Bitunix (Ù†Ø³Ø®Ù‡Ù” Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #111; color: #fff; }
    select, button, label { display: block; margin: 10px 0; }
    input[type="checkbox"] { transform: scale(1.3); margin-left: 8px; }
    #status { margin: 20px 0; padding: 12px; background: #222; border-radius: 8px; font-size: 14px; }
    .buy { background: #0a0 !important; color: white; }
    .sell { background: #a00 !important; color: white; }
  </style>
</head>
<body>
  <h2>ğŸ”Š Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ÙÛŒÙˆÚ†Ø±Ø² Bitunix</h2>
  <label>
    <input type="checkbox" id="useMacd" checked> 
    âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² MACD Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„
  </label>
  <select id="symbolSelect" style="width:100%; padding:10px; font-size:16px;">
    <option>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
  </select>
  <button onclick="requestNotification()">ğŸ”Š ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ùˆ ØµØ¯Ø§</button>
  <div id="status">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§ Ø§Ø² Bitunix...</div>

  <script>
    let currentSymbol = "JCTUSDT";
    let useMacd = true;

    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ùˆ ØµØ¯Ø§
    function requestNotification() {
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }
      playBeep();
    }

    // Ù¾Ø®Ø´ Ø¨ÙˆÙ‚ Ú©ÙˆØªØ§Ù‡
    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 800;
        gain.gain.value = 0.1;
        osc.start();
        setTimeout(() => { osc.stop(); }, 300);
      } catch (e) {
        console.log("Ù¾Ø®Ø´ ØµØ¯Ø§ Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª.");
      }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø±
    function showAlert(message, type) {
      const status = document.getElementById("status");
      status.textContent = message;
      status.className = type;
      playBeep();
      if (Notification.permission === "granted") {
        new Notification("ğŸš¨ Ø³ÛŒÚ¯Ù†Ø§Ù„!", { body: message });
      }
      console.log("[Ø³ÛŒÚ¯Ù†Ø§Ù„]", message);
    }

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª MACD
    document.getElementById("useMacd").onchange = (e) => {
      useMacd = e.target.checked;
    };

    // ğŸ”¥ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¬ÙØªâ€ŒÙ‡Ø§ÛŒ ÙÛŒÙˆÚ†Ø±Ø² Ø§Ø² Ø¢Ø¯Ø±Ø³ ÙˆØ§Ù‚Ø¹ÛŒ Bitunix
    async function fetchSymbols() {
      try {
        const url = "https://fapi.bitunix.com/api/v1/futures/market/trading_pairs";
        const res = await fetch(url);
        const data = await res.json();

        if (!data?.data?.length) {
          throw new Error("Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯");
        }

        const symbols = data.data.map(pair => pair.symbol).filter(sym => sym.includes("USDT"));
        const select = document.getElementById("symbolSelect");
        select.innerHTML = "";
        symbols.forEach(sym => {
          const opt = document.createElement("option");
          opt.value = sym;
          opt.textContent = sym;
          select.appendChild(opt);
        });

        currentSymbol = symbols[0] || "JCTUSDT";
        select.value = currentSymbol;
        select.onchange = () => { currentSymbol = select.value; };

        document.getElementById("status").textContent = "âœ… Ø¢Ù…Ø§Ø¯Ù‡! Ø§Ø±Ø² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.";
      } catch (e) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø±Ø²Ù‡Ø§:", e);
        document.getElementById("status").innerHTML = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Bitunix.<br>Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†ØªØ±Ù†ØªØª Ø±Ùˆ Ú†Ú© Ú©Ù† ÛŒØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†.";
      }
    }

    // ğŸ”¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø¢Ø¯Ø±Ø³ ÙˆØ§Ù‚Ø¹ÛŒ ÙÛŒÙˆÚ†Ø±Ø²
    async function fetchCandles(symbol) {
      try {
        const url = `https://fapi.bitunix.com/api/v1/futures/market/candles?symbol=${symbol}&interval=1m&limit=50`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data?.data?.length) {
          console.warn("Ø¯Ø§Ø¯Ù‡ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ", symbol, "ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯");
          return null;
        }

        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª: [openTime, open, high, low, close, volume]
        return data.data.map(c => ({
          close: parseFloat(c[4]),
          open: parseFloat(c[1]),
          high: parseFloat(c[2]),
          low: parseFloat(c[3]),
          time: parseInt(c[0])
        })).reverse(); // Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¢Ø®Ø±
      } catch (e) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯Ù„:", e);
        return null;
      }
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ MA
    function calculateMA(prices, period) {
      if (prices.length < period) return null;
      const slice = prices.slice(-period);
      return slice.reduce((a, b) => a + b, 0) / period;
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ MACD Ø³Ø§Ø¯Ù‡ (Ù‡Ù…ÙˆÙ†Ø·ÙˆØ± Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ú¯ÙØªÛŒÙ… â€” ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±)
    function calculateMACD(candles) {
      const closes = candles.map(c => c.close);
      if (closes.length < 26) return null;

      const sma12 = calculateMA(closes, 12);
      const sma26 = calculateMA(closes, 26);
      if (!sma12 || !sma26) return null;

      const macdLine = sma12 - sma26;
      const signalLine = calculateMA([macdLine], 9) || macdLine;
      return macdLine - signalLine; // Ù‡ÛŒØ³ØªÙˆÚ¯Ø±Ø§Ù…
    }

    // Ú†Ú© Ø³ÛŒÚ¯Ù†Ø§Ù„
    async function checkSignal() {
      const candles = await fetchCandles(currentSymbol);
      if (!candles || candles.length < 30) {
        document.getElementById("status").textContent = "âš ï¸ Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ MA Ù†ÛŒØ³Øª...";
        return;
      }

      const closes = candles.map(c => c.close);
      const ma5 = calculateMA(closes, 5);
      const ma10 = calculateMA(closes, 10);
      const ma20 = calculateMA(closes, 20);

      if (!ma5 || !ma10 || !ma20) {
        document.getElementById("status").textContent = "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ MA...";
        return;
      }

      let macdOk = true;
      if (useMacd) {
        const hist = calculateMACD(candles);
        if (hist === null) return;
        macdOk = hist > 0;
      }

      if (ma5 > ma10 && ma10 > ma20 && macdOk) {
        showAlert(`ğŸŸ¢ Ø®Ø±ÛŒØ¯! ${currentSymbol}`, "buy");
      } else if (ma5 < ma10 && ma10 < ma20 && (!useMacd || calculateMACD(candles) <= 0)) {
        showAlert(`ğŸ”´ ÙØ±ÙˆØ´! ${currentSymbol}`, "sell");
      }
    }

    // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
    fetchSymbols();
    document.getElementById("useMacd").checked = true;
    useMacd = true;

    requestNotification();
    setInterval(checkSignal, 30000); // Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
    setTimeout(checkSignal, 2000); // Ø§ÙˆÙ„ÛŒÙ† Ú†Ú© Ø¨Ø¹Ø¯ Ø§Ø² 2 Ø«Ø§Ù†ÛŒÙ‡
  </script>
</body>
</html>